'use strict';
const through = require('through2');
const libMod = require('./lib/');

function buildFile(options) {
    const config = Object.assign({
        namespace: '', //命名空间
        tplSuffix: '.tpl', //模板后缀
    }, options);
    return through.obj(function(file, encoding, callback) {
        // 如果是文件夹则跳过
        if(!file.isDirectory()) {
            let content = file.contents.toString(encoding);
            const requireList = libMod.getRequireList(content, config);
            // 替换模板文件
            if(requireList.templates.length > 0) {
                requireList.templates.forEach(function(tplPath) {
                    content = libMod.replaceTpl(file, tplPath, content);
                });
            }
            content = libMod.insertSeaWrapper(file, content, requireList, config);
            file.contents = Buffer.from(content);
        }
        callback(null, file);
    });
}
module.exports = buildFile;