'use strict';
const through = require('through2');
const libMod = require('./lib/');

function buildFile(options) {
    const config = Object.assign({
        domain: '',
        cssSuffix: '.css' //css后缀
    }, options);
    return through.obj(function(file, encoding, callback) {
        // 如果是文件夹则跳过
        if(!file.isDirectory()) {
            const validResult = libMod.validComponentFile(file, config);
            if(!validResult) return callback(null, file);
            let content = file.contents.toString(encoding);
            const staticfiles = libMod.getStaticFilesList(content);
            content = libMod.replaceStaticFile(file, content, staticfiles, config);
            // 兼容老buffer API
            if(Buffer.from) {
                file.contents = Buffer.from(content);
            }else {
                file.contents = new Buffer(content);
            }
        }
        callback(null, file);
    });
}
module.exports = buildFile;